#!/usr/bin/env bash
# File: git-set-shopify-branch.sh
# Purpose: rename/create a local branch "shopify", push it, and set it as the default on GitHub (if the repo is on GitHub).
# Usage: ./git-set-shopify-branch.sh [remote-name]
set -euo pipefail

REMOTE="${1:-origin}"
TARGET="shopify"

command -v git >/dev/null 2>&1 || { echo "git is required"; exit 1; }

# ensure we're in a git repo
git rev-parse --is-inside-work-tree >/dev/null 2>&1 || { echo "not a git repository"; exit 1; }

CURRENT="$(git rev-parse --abbrev-ref HEAD)"

# If current branch is main or master, rename it. Otherwise create a new branch from current.
if [[ "$CURRENT" == "main" || "$CURRENT" == "master" ]]; then
    echo "Renaming branch '$CURRENT' -> '$TARGET' (local)"
    git branch -m "$TARGET"
else
    if git show-ref --verify --quiet "refs/heads/$TARGET"; then
        echo "Branch '$TARGET' already exists locally. Checking it out."
        git checkout "$TARGET"
    else
        echo "Creating branch '$TARGET' from '$CURRENT'"
        git checkout -b "$TARGET"
    fi
fi

# Push branch and set upstream
echo "Pushing '$TARGET' to remote '$REMOTE' and setting upstream"
git push -u "$REMOTE" "$TARGET"

# If gh is available, attempt to set default branch on GitHub
if command -v gh >/dev/null 2>&1; then
    echo "Setting GitHub default branch to '$TARGET' (requires gh auth)"
    # get repo owner/name
    REPO_NAME="$(gh repo view --json nameWithOwner -q .nameWithOwner 2>/dev/null || true)"
    if [[ -n "$REPO_NAME" ]]; then
        gh repo edit --default-branch "$TARGET" "${REPO_NAME}" || {
            echo "gh edit failed; you may need permission or to authenticate."
            :
        }
        # open branches settings page in host browser if $BROWSER is set
        if [[ -n "${BROWSER:-}" ]]; then
            echo "Opening branch settings in browser"
            "$BROWSER" "https://github.com/${REPO_NAME}/settings/branches"
        fi
    else
        echo "Unable to determine repo name via gh. Skipping default-branch setting."
    fi
else
    echo "gh CLI not found. To set default branch on GitHub manually, visit your repo settings -> Branches."
    # try to open repo page if BROWSER and remote URL present
    if [[ -n "${BROWSER:-}" ]]; then
        REMOTE_URL="$(git remote get-url "$REMOTE" 2>/dev/null || true)"
        if [[ -n "$REMOTE_URL" ]]; then
            # transform git@github.com:owner/repo.git and https://github.com/owner/repo.git into owner/repo
            OWNER_REPO="$(echo "$REMOTE_URL" | sed -E 's#^git@github.com:(.*)\.git$#\1#; s#^https?://github.com/(.*)\.git$#\1#; s#^https?://github.com/(.*)$#\1#')"
            if [[ -n "$OWNER_REPO" ]]; then
                "$BROWSER" "https://github.com/${OWNER_REPO}/settings/branches"
            fi
        fi
    fi
fi

echo "Done. Verify CI, protections and any references to the old branch name if you changed it."